# 3.7. Компьютерные сети.Лекция 2

## 1. Проверьте список доступных сетевых интерфейсов на вашем компьютере. Какие команды есть для этого в Linux и в Windows?

	Linux:
```shell
denis@denis-lin(0):~$ ip -br link show
lo               UNKNOWN        00:00:00:00:00:00 <LOOPBACK,UP,LOWER_UP>
ens18            UP             2a:aa:2e:82:3a:b1 <BROADCAST,MULTICAST,UP,LOWER_UP>
vboxnet0         DOWN           0a:00:27:00:00:00 <BROADCAST,MULTICAST>
vboxnet1         DOWN           0a:00:27:00:00:01 <BROADCAST,MULTICAST>
denis@denis-lin(0):~$ ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 2a:aa:2e:82:3a:b1 brd ff:ff:ff:ff:ff:ff
    altname enp0s18
3: vboxnet0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 0a:00:27:00:00:00 brd ff:ff:ff:ff:ff:ff
4: vboxnet1: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 0a:00:27:00:00:01 brd ff:ff:ff:ff:ff:ff
denis@denis-lin(0):~$ netstat -i
Таблица интерфейсов ядра
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
ens18     1500  2510531      0 198300 0        286065      0      0      0 BMRU
lo       65536   756354      0      0 0        756354      0      0      0 LRU
```

	Windows:
```shell
PS C:\Users\VodyakovDV> ipconfig

Настройка протокола IP для Windows


Адаптер Ethernet Экземпляр Ethernet 0:

   DNS-суффикс подключения . . . . . : ComTeh
   Локальный IPv6-адрес канала . . . : fe80::ca81:7c:5b1f:5c72%2
   IPv4-адрес. . . . . . . . . . . . : 192.168.10.80
   Маска подсети . . . . . . . . . . : 255.255.255.0
   Основной шлюз. . . . . . . . . : 192.168.10.1

Неизвестный адаптер Подключение по локальной сети:

   Состояние среды. . . . . . . . : Среда передачи недоступна.
   DNS-суффикс подключения . . . . . :

PS C:\Users\VodyakovDV> netsh interface ip show interfaces

Инд     Мет         MTU          Состояние               Имя
---  ----------  ----------  ------------  ---------------------------
  1          75  4294967295  connected     Loopback Pseudo-Interface 1
 12          15        1500  disconnected  Подключение по локальной сети
  2          15        1500  connected     Экземпляр Ethernet 0

```

## 2. Какой протокол используется для распознавания соседа по сетевому интерфейсу? Какой пакет и команды есть в Linux для этого? 

	В основном для распознавания соседа используются протоколы обнаружения канального уровня реализованные по стандарту IEEE 802.1AB
	Для использования возможностей протокола в Linux используется утилита lldpd.
	lldpctl покажет информацию о соседях на интерфейсе (при условии, конечно, что у соседей разрешена передача данной информации).

```shell
denis@denis-lin(0):~$ lldpctl
-------------------------------------------------------------------------------
LLDP neighbors:
-------------------------------------------------------------------------------
Interface:    ens18, via: LLDP, RID: 4, Time: 0 day, 00:00:04
  Chassis:
    ChassisID:    mac e4:1f:13:68:5b:c8
    SysName:      ct-srv.net.loc
    SysDescr:     Debian GNU/Linux 11 (bullseye) Linux 5.13.19-2-pve #1 SMP PVE 5.13.19-4 (Mon, 29 Nov 2021 12:10:09 +0100) x86_64
    MgmtIP:       192.168.100.200
    MgmtIP:       fe80::e61f:13ff:fe68:5bc8
    Capability:   Bridge, on
    Capability:   Router, on
    Capability:   Wlan, off
    Capability:   Station, off
  Port:
    PortID:       mac f2:c2:f6:b1:c2:aa
    PortDescr:    tap202i0
    TTL:          120
    PMD autoneg:  supported: no, enabled: no
      MAU oper type: 10BaseTFD - UTP MAU, full duplex mode
-------------------------------------------------------------------------------
```

## 3. Какая технология используется для разделения L2 коммутатора на несколько виртуальных сетей? Какой пакет и команды есть в Linux для этого? Приведите пример конфига.
	
	Используется технология VLAN стандарта IEEE 802.1Q
	Пример debian / ProxMox
```shell
root@pve-host-01:~# cat /etc/network/interfaces
auto lo
iface lo inet loopback

iface eno3 inet manual

iface eno4 inet manual

auto eno1np0
iface eno1np0 inet manual

auto eno2np1
iface eno2np1 inet manual

auto bond0
iface bond0 inet manual
        bond-slaves eno1np0 eno2np1
        bond-miimon 100
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        mtu 9000
        bond-lacp_rate fast

auto vmbr0
iface vmbr0 inet manual
        bridge-ports bond0
        bridge-stp off
        bridge-fd 0
        bridge-vlan-aware yes
        bridge-vids 2-4094
        mtu 8972
#vlan-network

auto vmbr60
iface vmbr60 inet static
        address 10.179.60.101/23
        gateway 10.179.60.1
        bridge-ports bond0.60
        bridge-stp off
        bridge-fd 0

auto vlan2500
iface vlan2500 inet static
        address 10.250.1.1/23
        mtu 8972
        vlan-raw-device bond0

```
	Если используется netplan конфиг будет примерно такой:

```shell
vlans:
  vlan2500:      
    id: 2500     
    link: eth0  
    dhcp4: no
    addresses: [10.250.1.1/23]
```

## 4. Какие типы агрегации интерфейсов есть в Linux? Какие опции есть для балансировки нагрузки? Приведите пример конфига.

	В П.3. есть пример конфига 802.3ad (bond0)
	Режимы агрегации:
	* (balance-rr) – Данный режим используется по умолчанию. Balance-rr обеспечивается балансировку нагрузки и отказоустойчивость. В данном режиме сетевые пакеты отправляются “по кругу”, от первого интерфейса к последнему. Если выходят из строя интерфейсы, пакеты отправляются на остальные оставшиеся. Дополнительной настройки коммутатора не требуется при нахождении портов в одном коммутаторе. При разностных коммутаторах требуется дополнительная настройка.
	* (active-backup) – Один из интерфейсов работает в активном режиме, остальные в ожидающем. При обнаружении проблемы на активном интерфейсе производится переключение на ожидающий интерфейс. Не требуется поддержки от коммутатора.
	* (balance-xor) – Передача пакетов распределяется по типу входящего и исходящего трафика по формуле ((MAC src) XOR (MAC dest)) % число интерфейсов. Режим дает балансировку нагрузки и отказоустойчивость. Не требуется дополнительной настройки коммутатора/коммутаторов.
	* (broadcast) – Происходит передача во все объединенные интерфейсы, тем самым обеспечивая отказоустойчивость. Рекомендуется только для использования MULTICAST трафика.
	* (802.3ad) – динамическое объединение одинаковых портов. В данном режиме можно значительно увеличить пропускную способность входящего так и исходящего трафика. Для данного режима необходима поддержка и настройка коммутатора/коммутаторов.
	* (balance-tlb) – Адаптивная балансировки нагрузки трафика. Входящий трафик получается только активным интерфейсом, исходящий распределяется в зависимости от текущей загрузки канала каждого интерфейса. Не требуется специальной поддержки и настройки коммутатора/коммутаторов.
	* (balance-alb) – Адаптивная балансировка нагрузки. Отличается более совершенным алгоритмом балансировки нагрузки чем Mode-5). Обеспечивается балансировку нагрузки как исходящего, так и входящего трафика. Не требуется специальной поддержки и настройки коммутатора/коммутаторов.

## 5. Сколько IP адресов в сети с маской /29 ? Сколько /29 подсетей можно получить из сети с маской /24. Приведите несколько примеров /29 подсетей внутри сети 10.10.10.0/24.
	

```shell
denis@denis-lin(0):~$ ipcalc 10.10.10.0/29
Address:   10.10.10.0           00001010.00001010.00001010.00000 000
Netmask:   255.255.255.248 = 29 11111111.11111111.11111111.11111 000
Wildcard:  0.0.0.7              00000000.00000000.00000000.00000 111
=>
Network:   10.10.10.0/29        00001010.00001010.00001010.00000 000
HostMin:   10.10.10.1           00001010.00001010.00001010.00000 001
HostMax:   10.10.10.6           00001010.00001010.00001010.00000 110
Broadcast: 10.10.10.7           00001010.00001010.00001010.00000 111
Hosts/Net: 6                     Class A, Private Internet
```

	В сети маской /29 имеются 6 IP адресов


```shell
denis@denis-lin(0):~$ ipcalc 10.10.10.0/24 /29 | grep Subnets
Subnets after transition from /24 to /29
Subnets:   32

denis@denis-lin(0):~$ ipcalc 10.10.10.0/24 /29 | grep Network
Network:   10.10.10.0/24        00001010.00001010.00001010. 00000000
Network:   10.10.10.0/29        00001010.00001010.00001010.00000 000
Network:   10.10.10.8/29        00001010.00001010.00001010.00001 000
Network:   10.10.10.16/29       00001010.00001010.00001010.00010 000
Network:   10.10.10.24/29       00001010.00001010.00001010.00011 000
Network:   10.10.10.32/29       00001010.00001010.00001010.00100 000
Network:   10.10.10.40/29       00001010.00001010.00001010.00101 000
Network:   10.10.10.48/29       00001010.00001010.00001010.00110 000
Network:   10.10.10.56/29       00001010.00001010.00001010.00111 000
Network:   10.10.10.64/29       00001010.00001010.00001010.01000 000
Network:   10.10.10.72/29       00001010.00001010.00001010.01001 000
Network:   10.10.10.80/29       00001010.00001010.00001010.01010 000
Network:   10.10.10.88/29       00001010.00001010.00001010.01011 000
Network:   10.10.10.96/29       00001010.00001010.00001010.01100 000
Network:   10.10.10.104/29      00001010.00001010.00001010.01101 000
Network:   10.10.10.112/29      00001010.00001010.00001010.01110 000
Network:   10.10.10.120/29      00001010.00001010.00001010.01111 000
Network:   10.10.10.128/29      00001010.00001010.00001010.10000 000
Network:   10.10.10.136/29      00001010.00001010.00001010.10001 000
Network:   10.10.10.144/29      00001010.00001010.00001010.10010 000
Network:   10.10.10.152/29      00001010.00001010.00001010.10011 000
Network:   10.10.10.160/29      00001010.00001010.00001010.10100 000
Network:   10.10.10.168/29      00001010.00001010.00001010.10101 000
Network:   10.10.10.176/29      00001010.00001010.00001010.10110 000
Network:   10.10.10.184/29      00001010.00001010.00001010.10111 000
Network:   10.10.10.192/29      00001010.00001010.00001010.11000 000
Network:   10.10.10.200/29      00001010.00001010.00001010.11001 000
Network:   10.10.10.208/29      00001010.00001010.00001010.11010 000
Network:   10.10.10.216/29      00001010.00001010.00001010.11011 000
Network:   10.10.10.224/29      00001010.00001010.00001010.11100 000
Network:   10.10.10.232/29      00001010.00001010.00001010.11101 000
Network:   10.10.10.240/29      00001010.00001010.00001010.11110 000
Network:   10.10.10.248/29      00001010.00001010.00001010.11111 000
```

## 6. Задача: вас попросили организовать стык между 2-мя организациями. Диапазоны 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 уже заняты. Из какой подсети допустимо взять частные IP адреса? Маску выберите из расчета максимум 40-50 хостов внутри подсети.
	
	10.0.0.0/8 - все занято, 192.168.0.0/16 - все занято, 172.16.0.0/12 - все занято.
	Из частных сетей остается диапазон 100.64.0.0/10
	Далее /27 (30 хостов) сответсвенно нужно использовать /26 (62 хоста)

```shell
denis@denis-lin(0):~$ ipcalc 100.64.0.0/10 /26 | grep Subnets
Subnets after transition from /10 to /26
Subnets:   65536

denis@denis-lin(0):~$ ipcalc 100.64.0.0/10 /26 | head -n 22
Address:   100.64.0.0           01100100.01 000000.00000000.00000000
Netmask:   255.192.0.0 = 10     11111111.11 000000.00000000.00000000
Wildcard:  0.63.255.255         00000000.00 111111.11111111.11111111
=>
Network:   100.64.0.0/10        01100100.01 000000.00000000.00000000
HostMin:   100.64.0.1           01100100.01 000000.00000000.00000001
HostMax:   100.127.255.254      01100100.01 111111.11111111.11111110
Broadcast: 100.127.255.255      01100100.01 111111.11111111.11111111
Hosts/Net: 4194302               Class A

Subnets after transition from /10 to /26

Netmask:   255.255.255.192 = 26 11111111.11111111.11111111.11 000000
Wildcard:  0.0.0.63             00000000.00000000.00000000.00 111111

 1.
Network:   100.64.0.0/26        01100100.01000000.00000000.00 000000
HostMin:   100.64.0.1           01100100.01000000.00000000.00 000001
HostMax:   100.64.0.62          01100100.01000000.00000000.00 111110
Broadcast: 100.64.0.63          01100100.01000000.00000000.00 111111
Hosts/Net: 62                    Class A
```
	Собственно можем использовать 100.64.0.0/26, либо не ограничивать вывод и выбрать любой из 65536 вариантов :)

## 7. Как проверить ARP таблицу в Linux, Windows? Как очистить ARP кеш полностью? Как из ARP таблицы удалить только один нужный IP?

	Для просмотра ARP таблицы в Linux можно использовать команду ip neigh, в Windows arp -a.
	Для очистки ARP таблицы в Linux ip link set arp off dev <interface>; ip link set arp on dev <interface> (команда ip -s neigh flush all не удаляет записи, а делает их недействительными).
	в Windows netsh interface ip delete arpcache
	Удалить конкретную запись в Linux ip neigh del dev <interface> <host>, в Windows arp -d <host>

```shell
denis@denis-lin(0):~$ ip neigh
192.168.10.118 dev ens18 lladdr 9c:93:4e:96:9c:46 STALE
192.168.10.119 dev ens18 lladdr 9c:93:4e:bb:8c:76 STALE
192.168.10.126 dev ens18 lladdr 00:17:c8:3a:e3:84 STALE
192.168.10.1 dev ens18 lladdr c4:ad:34:55:72:59 STALE
192.168.10.80 dev ens18 lladdr b2:ec:cc:f6:96:a3 REACHABLE
192.168.10.109 dev ens18 lladdr f4:81:39:aa:82:3b STALE
192.168.100.181 dev ens18 lladdr d2:d5:c4:e5:8f:97 STALE
```

```shell
C:\Users\VodyakovDV>arp -a

Интерфейс: 192.168.10.80 --- 0x2
  адрес в Интернете      Физический адрес      Тип
  192.168.10.1          c4-ad-34-55-72-59     динамический
  192.168.10.50         00-00-85-bc-4c-5d     динамический
  192.168.10.52         b4-c4-fc-5e-75-8d     динамический
  192.168.10.54         10-3d-1c-07-9e-dc     динамический
  192.168.10.56         de-6b-e8-19-23-f5     динамический
  192.168.10.57         b4-2e-99-d3-58-af     динамический
  192.168.10.67         9a-a9-c6-84-9b-60     динамический
  192.168.10.71         24-4b-fe-01-17-bb     динамический
  192.168.10.74         a8-f9-4b-0e-ee-a4     динамический
  192.168.10.75         08-62-66-28-03-a1     динамический
  192.168.10.76         7c-10-c9-a1-77-96     динамический
  192.168.10.77         ac-b5-7d-5d-24-0e     динамический
...
```
