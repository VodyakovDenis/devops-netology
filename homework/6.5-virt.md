# Домашнее задание к занятию 5. «Elasticsearch»## Задача 1В этом задании вы потренируетесь в:- установке Elasticsearch,- первоначальном конфигурировании Elasticsearch,- запуске Elasticsearch в Docker.Используя Docker-образ [centos:7](https://hub.docker.com/_/centos) как базовый и [документацию по установке и запуску Elastcisearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html):- составьте Dockerfile-манифест для Elasticsearch,- соберите Docker-образ и сделайте `push` в ваш docker.io-репозиторий,- запустите контейнер из получившегося образа и выполните запрос пути `/` c хост-машины.Требования к `elasticsearch.yml`:- данные `path` должны сохраняться в `/var/lib`,- имя ноды должно быть `netology_test`.В ответе приведите:- текст Dockerfile-манифеста,- ссылку на образ в репозитории dockerhub,- ответ `Elasticsearch` на запрос пути `/` в json-виде.Подсказки:- возможно, вам понадобится установка пакета perl-Digest-SHA для корректной работы пакета shasum,- при сетевых проблемах внимательно изучите кластерные и сетевые настройки в elasticsearch.yml,- при некоторых проблемах вам поможет Docker-директива ulimit,- Elasticsearch в логах обычно описывает проблему и пути её решения.Далее мы будем работать с этим экземпляром Elasticsearch.### Решение```denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat DockerfileFROM centos:7RUN cd /opt && \    groupadd elasticsearch && \    useradd -c "elasticsearch" -g elasticsearch elasticsearch &&\    yum update -y && yum -y install wget perl-Digest-SHA && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.6.2-linux-x86_64.tar.gz && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \    shasum -a 512 -c elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \    tar -xzf elasticsearch-8.6.2-linux-x86_64.tar.gz && \        rm elasticsearch-8.6.2-linux-x86_64.tar.gz elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \        mkdir /var/lib/data && chmod -R 777 /var/lib/data && \        chown -R elasticsearch:elasticsearch /opt/elasticsearch-8.6.2 && \        yum -y remove wget perl-Digest-SHA && \        yum clean allUSER elasticsearchWORKDIR /opt/elasticsearch-8.6.2/COPY elasticsearch.yml  config/EXPOSE 9200 9300ENTRYPOINT ["bin/elasticsearch"]denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat elasticsearch.ymlnode:  name: netology_testpath:  data: /var/lib/dataxpack.ml.enabled: false```	Собираем, пушим и запускаем образ (проблему с доступом к artifacts.elastic.co - решил впн)```denis@denis-lin(0):~/netology/devops-netology/hw6.5$ sudo docker build -t vodyakovdenis/elasticsearch:1.0 .... тут он собирается долго и нудно т.к. доступно было только через USA маршрут ...denis@denis-lin(0):~/netology/devops-netology/hw6.5$ sudo docker imagesREPOSITORY                    TAG       IMAGE ID       CREATED          SIZEvodyakovdenis/elasticsearch   1.0       6d7e4810c616   16 seconds ago   1.6GBdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ sudo docker run --name elasticsearch -d -p 9200:9200 -p 9300:9300  vodyakovdenis/elasticsearch:1.08272c17832c66893844f3e0edf96253d72514b512b46c7cc4e7c0678802f49df.... Сброс паролей ....[elasticsearch@8272c17832c6 elasticsearch-8.6.2]$ ./bin/elasticsearch-setup-passwords interactive...denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl --insecure -u elastic https://localhost:9200Enter host password for user 'elastic':{  "name" : "netology_test",  "cluster_name" : "elasticsearch",  "cluster_uuid" : "dfkUAbYfSsW5Ha-cLVdraQ",  "version" : {    "number" : "8.6.2",    "build_flavor" : "default",    "build_type" : "tar",    "build_hash" : "2d58d0f136141f03239816a4e360a8d17b6d8f29",    "build_date" : "2023-02-13T09:35:20.314882762Z",    "build_snapshot" : false,    "lucene_version" : "9.4.2",    "minimum_wire_compatibility_version" : "7.17.0",    "minimum_index_compatibility_version" : "7.0.0"  },  "tagline" : "You Know, for Search"}...denis@denis-lin(0):~/netology/devops-netology/hw6.5$ sudo docker push vodyakovdenis/elasticsearch:1.0The push refers to repository [docker.io/vodyakovdenis/elasticsearch]5b6ebb6e953a: Pushed29a097342f1e: Pushed174f56854903: Mounted from library/centos1.0: digest: sha256:dfc7b40cc60a8ccfdeae742b63487e1151deb062b35b60ec4cedf38e5eec0b9a size: 949```Ссылка на образ в docker hub: https://hub.docker.com/repository/docker/vodyakovdenis/elasticsearch/general## Задача 2В этом задании вы научитесь:- создавать и удалять индексы,- изучать состояние кластера,- обосновывать причину деградации доступности данных.Ознакомьтесь с [документацией](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html) и добавьте в `Elasticsearch` 3 индекса в соответствии с таблицей:| Имя | Количество реплик | Количество шард ||-----|-------------------|-----------------|| ind-1| 0 | 1 || ind-2 | 1 | 2 || ind-3 | 2 | 4 |Получите список индексов и их статусов, используя API, и **приведите в ответе** на задание.Получите состояние кластера `Elasticsearch`, используя API.Как вы думаете, почему часть индексов и кластер находятся в состоянии yellow?Удалите все индексы.**Важно**При проектировании кластера Elasticsearch нужно корректно рассчитывать количество реплик и шард,иначе возможна потеря данных индексов, вплоть до полной, при деградации системы.### Решение```denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/ind-1?pretty" -H 'Content-Type: application/json' -d'> {>   "settings": {>     "index": {>       "number_of_shards": 1,>       "number_of_replicas": 0>     }>   }> }> 'Enter host password for user 'elastic':{  "acknowledged" : true,  "shards_acknowledged" : true,  "index" : "ind-1"}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/ind-2?pretty" -H 'Content-Type: application/json' -d'> {>   "settings": {>     "index": {>       "number_of_shards": 2,>       "number_of_replicas": 1>     }>   }> }> 'Enter host password for user 'elastic':{  "acknowledged" : true,  "shards_acknowledged" : true,  "index" : "ind-2"}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/ind-3?pretty" -H 'Content-Type: application/json' -d'> {>   "settings": {>     "index": {>       "number_of_shards": 4,>       "number_of_replicas": 2>     }>   }> }> 'Enter host password for user 'elastic':{  "acknowledged" : true,  "shards_acknowledged" : true,  "index" : "ind-3"}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic https://localhost:9200/_cat/indices?v=trueEnter host password for user 'elastic':health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   ind-1 b-ycSTsaTaGFLZXck9xg9w   1   0          0            0       225b           225byellow open   ind-3 7LIlwo_gTc-C0vUMjPuyDg   4   2          0            0       900b           900byellow open   ind-2 7-n3NtOuSGSPuwGUkQshgA   2   1          0            0       450b           450bdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic "https://localhost:9200/_cluster/health?pretty"Enter host password for user 'elastic':{  "cluster_name" : "elasticsearch",  "status" : "yellow",  "timed_out" : false,  "number_of_nodes" : 1,  "number_of_data_nodes" : 1,  "active_primary_shards" : 9,  "active_shards" : 9,  "relocating_shards" : 0,  "initializing_shards" : 0,  "unassigned_shards" : 10,  "delayed_unassigned_shards" : 0,  "number_of_pending_tasks" : 0,  "number_of_in_flight_fetch" : 0,  "task_max_waiting_in_queue_millis" : 0,  "active_shards_percent_as_number" : 47.368421052631575}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X DELETE --insecure -u elastic "https://localhost:9200/ind-1?pretty"Enter host password for user 'elastic':{  "acknowledged" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X DELETE --insecure -u elastic "https://localhost:9200/ind-2?pretty"Enter host password for user 'elastic':{  "acknowledged" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X DELETE --insecure -u elastic "https://localhost:9200/ind-3?pretty"Enter host password for user 'elastic':{  "acknowledged" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic https://localhost:9200/_cat/indices?v=trueEnter host password for user 'elastic':health status index uuid pri rep docs.count docs.deleted store.size pri.store.size```- Как вы думаете, почему часть индексов и кластер находится в состоянии yellow?  Думаю потому что кластера нету, имеем только одну ноду которая является мастером, соответсвенно в соответсвии с настройкой нет реплик у двух желтых.## Задача 3В этом задании вы научитесь:- создавать бэкапы данных,- восстанавливать индексы из бэкапов.Создайте директорию `{путь до корневой директории с Elasticsearch в образе}/snapshots`.Используя API, [зарегистрируйте](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html#snapshots-register-repository) эту директорию как `snapshot repository` c именем `netology_backup`.**Приведите в ответе** запрос API и результат вызова API для создания репозитория.Создайте индекс `test` с 0 реплик и 1 шардом и **приведите в ответе** список индексов.[Создайте `snapshot`](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html) состояния кластера `Elasticsearch`.**Приведите в ответе** список файлов в директории со `snapshot`.Удалите индекс `test` и создайте индекс `test-2`. **Приведите в ответе** список индексов.[Восстановите](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html) состояниекластера `Elasticsearch` из `snapshot`, созданного ранее. **Приведите в ответе** запрос к API восстановления и итоговый список индексов.Подсказки:- возможно, вам понадобится доработать `elasticsearch.yml` в части директивы `path.repo` и перезапустить `Elasticsearch`.### Решение   Решил пересоздать контейнер с подключением внутри каталога.```denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat start_elasticsearch.shdocker run -d --restart unless-stopped --stop-timeout 300 \    -p 9200:9200 \    -p 9300:9300 \    --mount type=bind,source="/home/denis/netology/devops-netology/hw6.5/data",target="/opt/elasticsearch-8.6.2/data" \    --name elasticsearch vodyakovdenis/elasticsearch:1.1```   Входим в контейнер```[elasticsearch@95a7af3decc8 elasticsearch-8.6.2]$ cat config/elasticsearch.ymlnode:  name: netology_testpath:  data: /var/lib/data  repo: /opt/elasticsearch-8.6.2/data/snapshotxpack.ml.enabled: false....denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic:pass "https://localhost:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'> {>   "type": "fs",>   "settings": {>     "location": "/opt/elasticsearch-8.6.2/data/snapshot">   }> }> '{  "acknowledged" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/test?pretty" -H 'Content-Type: application/json' -d'> {>   "settings": {>     "index": {>       "number_of_shards": 1,>       "number_of_replicas": 0>     }>   }> }> 'Enter host password for user 'elastic':{  "acknowledged" : true,  "shards_acknowledged" : true,  "index" : "test"}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic "https://localhost:9200/_cat/indices/*?v=true&s=index&pretty"Enter host password for user 'elastic':health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test  Euy1zYfJQ_mznduQ21f9cQ   1   0          0            0       225b           225bdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/_snapshot/netology_backup/my_snapshot?pretty"Enter host password for user 'elastic':{  "accepted" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ ls -l data/snapshot/итого 36-rw-r--r-- 1 denis denis  1096 мар 30 11:44 index-0-rw-r--r-- 1 denis denis     8 мар 30 11:44 index.latestdrwxr-xr-x 5 denis denis  4096 мар 30 11:44 indices-rw-r--r-- 1 denis denis 18695 мар 30 11:44 meta-1acYlg-yS-62C3Pj4svT8A.dat-rw-r--r-- 1 denis denis   384 мар 30 11:44 snap-1acYlg-yS-62C3Pj4svT8A.datdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X DELETE --insecure -u elastic "https://localhost:9200/test?pretty"Enter host password for user 'elastic':{  "acknowledged" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X PUT --insecure -u elastic "https://localhost:9200/test-2?pretty" -H 'Content-Type: application/json' -d'> {>   "settings": {>     "index": {>       "number_of_shards": 1,>       "number_of_replicas": 0>     }>   }> }> 'Enter host password for user 'elastic':{  "acknowledged" : true,  "shards_acknowledged" : true,  "index" : "test-2"}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic "https://localhost:9200/_cat/indices/*?v=true&s=index&pretty"Enter host password for user 'elastic':health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test-2 kdh1e0CSQxG6XA_MLdviug   1   0          0            0       225b           225bdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X POST --insecure -u elastic "https://localhost:9200/_snapshot/netology_backup/my_snapshot/_restore?pretty"Enter host password for user 'elastic':{  "accepted" : true}denis@denis-lin(0):~/netology/devops-netology/hw6.5$ curl -X GET --insecure -u elastic "https://localhost:9200/_cat/indices/*?v=true&s=index&pretty"Enter host password for user 'elastic':health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test   K1IlySi9SQq8mESwnEkosQ   1   0          0            0       225b           225bgreen  open   test-2 kdh1e0CSQxG6XA_MLdviug   1   0          0            0       225b           225b```### PSДля решения 3 задачи были внесены изменения:```denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat DockerfileFROM centos:7RUN cd /opt && \    groupadd elasticsearch && \    useradd -c "elasticsearch" -g elasticsearch elasticsearch &&\    yum update -y && yum -y install wget nano mc perl-Digest-SHA && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.6.2-linux-x86_64.tar.gz && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \    shasum -a 512 -c elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \    tar -xzf elasticsearch-8.6.2-linux-x86_64.tar.gz && \        rm elasticsearch-8.6.2-linux-x86_64.tar.gz elasticsearch-8.6.2-linux-x86_64.tar.gz.sha512 && \        mkdir /var/lib/data && chmod -R 777 /var/lib/data && \        chown -R elasticsearch:elasticsearch /opt/elasticsearch-8.6.2 && \        yum -y remove wget perl-Digest-SHA && \        yum clean allUSER elasticsearchWORKDIR /opt/elasticsearch-8.6.2/COPY elasticsearch.yml  config/EXPOSE 9200 9300ENTRYPOINT ["bin/elasticsearch"]denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat elasticsearch.ymlnode:  name: netology_testpath:  data: /var/lib/data  repo: /opt/elasticsearch-8.6.2/data/snapshotdenis@denis-lin(0):~/netology/devops-netology/hw6.5$ sudo docker push vodyakovdenis/elasticsearch:1.1The push refers to repository [docker.io/vodyakovdenis/elasticsearch]69ba6013afc3: Pushedefb3babf2450: Pushed174f56854903: Layer already exists1.1: digest: sha256:887d1d0d6ac455d577390420a1adec2f667819ac7d7c8136cbf7b5496ccad8c4 size: 949denis@denis-lin(0):~/netology/devops-netology/hw6.5$ cat start_elasticsearch.shdocker run -d --restart unless-stopped --stop-timeout 300 \    -p 9200:9200 \    -p 9300:9300 \    --mount type=bind,source="/home/denis/netology/devops-netology/hw6.5/data",target="/opt/elasticsearch-8.6.2/data" \    --name elasticsearch vodyakovdenis/elasticsearch:1.1```Как вариант доработки вижу следующее в start_elasticsearch.sh добавить строку:   	--mount type=bind,source="/home/denis/netology/devops-netology/hw6.5/elasticsearch.yml",target="/opt/elasticsearch-8.6.2/config/elasticsearch.yml" \   Из Dockerfile можно исключить    	COPY elasticsearch.yml  config/