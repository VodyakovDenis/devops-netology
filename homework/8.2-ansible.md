# Домашнее задание к занятию 2 «Работа с Playbook»

## Основная часть

1. Подготовьте свой inventory-файл [prod.yml](./hw8.2/playbook/inventory/prod.yml).
```
denis@denis-lin(0):~/netology/devops-netology/homework/hw8.2/playbook$ cat inventory/prod.yml
---
vector:
    hosts:
      hw82-vector:
        ansible_host: 192.168.10.83
```
	Для выполнения работы создал LXC на базе ubuntu 22.10 - соответственно все дальнейшие действия выполнял с данным контейнером.

2. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает [vector](https://vector.dev).   

	Изначально создал отдельный плейбук [vector.yml](./hw8.2/playbook/vector.yml). 

3. При создании tasks рекомендую использовать модули: `get_url`, `template`, `unarchive`, `file`.

	Ok

4. Tasks должны: скачать дистрибутив нужной версии, выполнить распаковку в выбранную директорию, установить vector.

	Оk

5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

	Т.К. изначально site.yml был написан под yum, а соответсвенно Centos, переписал его полностью под Ubuntu основываясь на оф [документации](https://clickhouse.com/docs/ru/getting-started/install).
```bash
sudo apt-get install -y apt-transport-https ca-certificates dirmngr
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754

echo "deb https://packages.clickhouse.com/deb stable main" | sudo tee \
    /etc/apt/sources.list.d/clickhouse.list
sudo apt-get update

sudo apt-get install -y clickhouse-server clickhouse-client

sudo service clickhouse-server start
clickhouse-client # or "clickhouse-client --password" if you've set up a password.

```

- Оформил в виде плейбука [site.yml](./hw8.2/playbook/site.yml).

6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

	Много раз использовал данный флаг при написании как vector так и clichause, так-же для отладки добавлял -vv и -vvv

7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
```bash
denis@denis-lin(0):~/netology/devops-netology/homework/hw8.2/playbook$ ansible-playbook -i inventory/prod.yml all.yml --diff

PLAY [Install ClickHouse] ************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [AptInst] ***********************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Add ClickHouse repository key] *************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Add ClickHouse repository] *****************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Update APT cache] **************************************************************************************************************************************************************************************************************************************************************************
changed: [hw82-vector]

TASK [Install ClickHouse server and client] ******************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Start ClickHouse server] *******************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Create database] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

PLAY [Install Vector] ****************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Install tar] *******************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Vector distrib] ****************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Unpack vector distrib] *********************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Install vector] ****************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Check vector version] **********************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

PLAY RECAP ***************************************************************************************************************************************************************************************************************************************************************************************
hw82-vector                : ok=14   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```
	Чтоб changed не было можно заменить на become:false

8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
```bash
denis@denis-lin(0):~/netology/devops-netology/homework/hw8.2/playbook$ ansible-playbook -i inventory/prod.yml all.yml --diff

PLAY [Install ClickHouse] ************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [AptInst] ***********************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Add ClickHouse repository key] *************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Add ClickHouse repository] *****************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Update APT cache] **************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Install ClickHouse server and client] ******************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Start ClickHouse server] *******************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Create database] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

PLAY [Install Vector] ****************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Install tar] *******************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Vector distrib] ****************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Unpack vector distrib] *********************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Install vector] ****************************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

TASK [Check vector version] **********************************************************************************************************************************************************************************************************************************************************************
ok: [hw82-vector]

PLAY RECAP ***************************************************************************************************************************************************************************************************************************************************************************************
hw82-vector                : ok=14   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.

- [README.md](./hw8.2/playbook/README.md)

10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-02-playbook` на фиксирующий коммит, в ответ предоставьте ссылку на него.
